# Scripts Used for Cornell CM Produciton Checkout

## IBERTpy Plotting Script

### Overview
### Requirements
- **Python 2.7**
### Instructions

## C2C-link Eyescans Script

### Overview
`mcu_tools` submodule contains automate scripts in the shell directory to create a weekly-report directory in `/nfs/cms/hw/apollo/` and run C2C eyescans on any apollo blades. We note that currently a one-by-one eyescan and parallel eyescans are enable. The exception is that on apollo09 only three*/four c2c links are working.  
### Requirements
- **Python 2.7** 
- **lnx4189.classe.cornell.edu machine** 
- ssh key-pair to **Apollo## blade**
### Instructions
There are four C2C transceivers with RX-eyescans enable on each rev1 apollo blade. That includes:
```INI
1: C2C1_PHY (RX on Zynq from Virtex)
2: C2C2_PHY (RX on Zynq from Kintex)
3: K_C2C_PHY (RX on Kintex from Zynq)
4: V_C2C_PHY (RX on Virtex from Zynq)
```

* Only K_C2C_PHY is not working (update on 02/01/2022)

Given that we know the Apollo## blade and ttydevice(e.g. ttyUL1)

Run the following command on lnx4189 if the weekly-report directory needs to be created (Weekly = Mon-Sun and WeekXX where XX = 1-53)
```sh
shell $ ./automate_mkdir_CM.sh
```
The program will create a directory `/CMXX/weekXX-MM-YYYY/` in `/nfs/cms/hw/apollo/` in order to save `*.png` and `*.log` files from running eyescans with `BUTool.exe` on Apollo## (in the next step)

Here is the next step to run BUTool.exe and transfer `*.png` and `*.log` results of running one eyescan of a C2C link at a time

Run the following command on lnx4189 to just run a single eyescan at a time
```sh
shell $ ./automate_apollo_single_eyescan.sh
```
Run the following command on lnx4189 to run eyescans in parallel. 
```sh
shell $ ./automate_apollo_parallel_eyescans.sh
```

These programs will ask for Apollo##-CM## pair, as well as the C2C link number (1,2,..etc.) for the single-eyescan script. They will `ssh` to its corresponding Zynq and run either **c2c_single_eyescan_script** or **c2c_parallel_eyescans_script** in `peace/ApolloTool`(subject to change by a given username) folder. Then, they will take a few minutes to run, depending on the customizable numbers of x-binning, y-binnning, and maximum prescale inside the above automate shell script. The current set of these parameters is {binx=40,biny=40,max_prescale=6}. 

Two files(`*.png` + `*.log`) per one eyescan or three* `*.png` and one `*.log' files will be transfered to the weekly-report folder if the corresponding one exists. 

## Autotuning System for Xilinx MGTs

### Overview
Directory containing scripts to tune the emphasis and equalization of
high-speed serial links between two Xilinx FPGA's.

### Requirements
- **Python 3+**
- **Vivado** (the scripts consider that it is possible to start the vivado
  software by calling *vivado* at the terminal. If that is not the case, change
  the \_\_init\_\_ method of XilinxTCL class)
- Boards programmed with the **IBERT bitstream**, configured with the MGT's to
  be tuned at the desired line rate

### Instructions
The autotuning is done in 3 steps: **preparing the boards**, **setting the
*config.ini*** and **running the autotuning script**. In this respository, all
parameters were set for an optical transmission between two KC705 kits, running
at 10 Gbps and using PRBS31.

#### Preparing the boards
The transmitter and receiver boards should be programmed with an IBERT bitstream
generated by Vivado. The line rate, reference clock and enabled MGT's should be
set according to the conditions the system is going to operate.

#### [Optional] Set up the automated autotuning script
Please create and/or adjust the hw_*.tcl in the autotuning/automate folder.

#### Setting the *config.ini*
The *config.ini* file is where the test parameters should be set. They are
loaded by the *run.py* script and specify the MGT's to be tuned, the tuning
configurations to be tested, stop conditions for the tuning process, among other
parameters. The file is organized in sections and their variables, as the
following example:

```INI

[Section1]
variable1 = value
variable2 = value

[Section2]
variable3 = value
variable4 = value
variable5 = value

[DEFAULT]
variable1 = value
variable4 = value
variable5 = value

```

The DEFAULT section is a special one, and stablishes the default value for some
of the variables of other sections. If they are not set in their own sections,
the DEFAULT value is used.

#### Running the autotuning script
The autotuning script is run by the following command:

```sh
$ python3 run.py
```

It loads the parameters in *config.ini*, opening two vivado instances and
connecting one to the transmitter and the other to the receiver FPGA. The
initial setting it then loaded through TCL files, which can set the initial
tuning configuration, PRBS pattern, DFE setting and invert RX/TX differential
pins (if this is required by the PCB design. The script then tests everyone of
the tuning configurations, saves its performance in a CSV file and then presents
the best configuration found.

#### [Optional] Run the automated autotuning script
This script opens Vivado instances and configures the FPGAs with bit files. The 
Vivado instances remain open (no need to start Vivado by yourself). Then the test 
is perormed by using the run.py script:

```sh
$ cd automate
$ ./run_MGT_autotune.sh
```

### Results
The results are presented in a CSV file. The columns present the TX Differential
Swing, TX Pre, TX Post, RX termination voltage and the respective eye scan open
area resultant for that configuration. This parameter measures how open the eye
scan is, and should be maximized to improve the link integrity. An example of a
CSV result file is shown bellow.

```CSV
TXDIFFSWING,TXPRE,TXPOST,RXTERM,Open Area
269 mV (0000),0.00 dB (00000),0.00 dB (00000),900 mV,2664
269 mV (0000),0.00 dB (00000),4.44 dB (10000),900 mV,2268
269 mV (0000),4.44 dB (10000),0.00 dB (00000),900 mV,1692
269 mV (0000),4.44 dB (10000),4.44 dB (10000),900 mV,1332
------------BEST------------
269 mV (0000),0.00 dB (00000),0.00 dB (00000),900 mV,2664

```
